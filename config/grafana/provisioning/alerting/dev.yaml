apiVersion: 1
groups:
    - orgId: 1
      name: Cloudwatch alerts
      folder: VBP - DEV
      interval: 10m
      rules:
        - uid: alerts-error-logs-dev
          title: Errors in ECS logs
          condition: C
          data:
            - refId: A
              relativeTimeRange:
                from: 900
                to: 0
              datasourceUid: cloudwatch-dev
              model:
                dimensions: {}
                expression: |-
                    fields @timestamp, @message, @logStream |
                      filter @message like /\[ERROR\]/ |
                      sort @timestamp desc |
                      parse @message /\[ERROR\](?<error>.+?)(?: \[AWS-XRAY-TRACE-ID: (?<@xrayTraceId>.+?)@(?<@xraySegementId>.+?)\])?\n/ |
                      parse @logStream /^(?<service>.+?)\/(?<container>.+?)\/(?<containerId>.+)/ |
                      stats count(*) as count by service, container, containerId, error, bin(1m) |
                      limit 10
                id: ""
                intervalMs: 60000
                label: ""
                logGroups:
                    - arn: /inbo/vbp/ecs
                      name: /inbo/vbp/ecs
                matchExact: true
                maxDataPoints: 100
                metricEditorMode: 0
                metricName: ""
                metricQueryType: 0
                namespace: ""
                period: ""
                queryMode: Logs
                refId: A
                region: default
                sqlExpression: ""
                statistic: Average
                statsGroups:
                    - service
                    - container
                    - containerId
                    - error
                    - bin(1m)
            - refId: B
              relativeTimeRange:
                from: 900
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0
                            - 0
                        type: gt
                      operator:
                        type: and
                      query:
                        params: []
                      reducer:
                        params: []
                        type: avg
                      type: query
                datasource:
                    name: Expression
                    type: __expr__
                    uid: __expr__
                expression: A
                intervalMs: 1000
                maxDataPoints: 43200
                reducer: sum
                refId: B
                settings:
                    mode: dropNN
                type: reduce
            - refId: C
              relativeTimeRange:
                from: 900
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0
                            - 0
                        type: gt
                      operator:
                        type: and
                      query:
                        params: []
                      reducer:
                        params: []
                        type: avg
                      type: query
                datasource:
                    name: Expression
                    type: __expr__
                    uid: __expr__
                expression: B
                intervalMs: 1000
                maxDataPoints: 43200
                refId: C
                type: threshold
          dashboardUid: ecs-logs-dev
          panelId: 1
          noDataState: OK
          execErrState: Error
          for: 0s
          annotations:
            __dashboardUid__: ecs-logs-dev
            __panelId__: "1"
            description: <code>{{ reReplaceAll "\\x1b\\[[;\\d]*[A-Za-z]" "" $labels.error }}</code>
            summary: 'Container {{ $labels.container }} for service {{ $labels.service }} logged an error:'
          isPaused: false
          labels:
            "notify": "google"
        - uid: alerts-running-tasks-dev
          title: Failing running tasks
          condition: E
          data:
            - refId: A
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: cloudwatch-dev
              model:
                dimensions:
                    ClusterName: inbo-vbp-cluster
                    ServiceName: '*'
                expression: ""
                id: ""
                intervalMs: 1000
                label: ""
                logGroups: []
                matchExact: true
                maxDataPoints: 43200
                metricEditorMode: 0
                metricName: RunningTaskCount
                metricQueryType: 0
                namespace: ECS/ContainerInsights
                period: ""
                queryMode: Metrics
                refId: A
                region: default
                sqlExpression: ""
                statistic: Average
            - refId: B
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: cloudwatch-dev
              model:
                datasource:
                    type: cloudwatch
                    uid: cloudwatch-dev
                dimensions:
                    ClusterName: inbo-vbp-cluster
                    ServiceName: '*'
                expression: ""
                id: ""
                intervalMs: 60000
                label: ""
                logGroups: []
                matchExact: true
                maxDataPoints: 43200
                metricEditorMode: 0
                metricName: DesiredTaskCount
                metricQueryType: 0
                namespace: ECS/ContainerInsights
                period: ""
                queryMode: Metrics
                refId: B
                region: default
                sqlExpression: ""
                statistic: Average
            - refId: C
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0
                            - 0
                        type: gt
                      operator:
                        type: and
                      query:
                        params: []
                      reducer:
                        params: []
                        type: avg
                      type: query
                datasource:
                    name: Expression
                    type: __expr__
                    uid: __expr__
                expression: $B - $A
                intervalMs: 1000
                maxDataPoints: 43200
                refId: C
                type: math
            - refId: D
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0
                            - 0
                        type: gt
                      operator:
                        type: and
                      query:
                        params: []
                      reducer:
                        params: []
                        type: avg
                      type: query
                datasource:
                    name: Expression
                    type: __expr__
                    uid: __expr__
                expression: C
                intervalMs: 1000
                maxDataPoints: 43200
                reducer: last
                refId: D
                type: reduce
            - refId: E
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0
                            - 0
                        type: gt
                      operator:
                        type: and
                      query:
                        params: []
                      reducer:
                        params: []
                        type: avg
                      type: query
                datasource:
                    name: Expression
                    type: __expr__
                    uid: __expr__
                expression: D
                intervalMs: 1000
                maxDataPoints: 43200
                refId: E
                type: threshold
          dashboardUid: portal-health-dev
          panelId: 97
          noDataState: NoData
          execErrState: Error
          for: 5m
          annotations:
            __dashboardUid__: portal-health-dev
            __panelId__: "97"
            description: ""
            runbook_url: ""
            summary: '{{ $labels.ServiceName }} doesn''t have enough running tasks'
          labels:
            "notify": "google"
          isPaused: false
        - uid: alerts-elb-target-health-dev
          title: Load Balancer Target Health
          condition: C
          data:
            - refId: A
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: cloudwatch-dev
              model:
                dimensions:
                    LoadBalancer: app/inbo-vbp-public/a744d69ec78da33a
                    TargetGroup: '*'
                expression: ""
                id: ""
                intervalMs: 60000
                label: ""
                logGroups: []
                matchExact: true
                maxDataPoints: 43200
                metricEditorMode: 0
                metricName: UnHealthyHostCount
                metricQueryType: 0
                namespace: AWS/ApplicationELB
                period: ""
                queryMode: Metrics
                refId: A
                region: default
                sqlExpression: ""
                statistic: Maximum
            - refId: B
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params: []
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - B
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: A
                intervalMs: 1000
                maxDataPoints: 43200
                reducer: last
                refId: B
                settings:
                    mode: dropNN
                type: reduce
            - refId: C
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - C
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: B
                intervalMs: 1000
                maxDataPoints: 43200
                refId: C
                type: threshold
          dashboardUid: portal-health-dev
          panelId: 168
          noDataState: NoData
          execErrState: Error
          for: 5m
          annotations:
            __dashboardUid__: portal-health-dev
            __panelId__: "168"
            summary: Load balancer target {{ $labels.TargetGroup }} has unhealthy hosts
          isPaused: false
          labels:
            "notify": "google"
        - uid: alerts-aws-rum-errors-dev
          title: AWS RUM Error
          condition: C
          data:
            - refId: A
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: cloudwatch-dev
              model:
                dimensions:
                    application_name: inbo-vbp-portal
                expression: ""
                id: ""
                intervalMs: 60000
                label: ""
                logGroups: []
                matchExact: true
                maxDataPoints: 43200
                metricEditorMode: 0
                metricName: JsErrorCount
                metricQueryType: 0
                namespace: AWS/RUM
                period: ""
                queryMode: Metrics
                refId: A
                region: default
                sqlExpression: ""
                statistic: Sum
            - refId: B
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params: []
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - B
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: A
                intervalMs: 1000
                maxDataPoints: 43200
                reducer: last
                refId: B
                settings:
                    mode: dropNN
                type: reduce
            - refId: C
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - C
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: B
                intervalMs: 1000
                maxDataPoints: 43200
                refId: C
                type: threshold
          noDataState: OK
          execErrState: Error
          for: 0s
          annotations:
            summary: Some JS Errors were detected in the front-end
          isPaused: false
          labels:
            "notify": "google"
